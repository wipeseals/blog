<!DOCTYPE html>
<html lang="en">

<head>
    <title>blog.wipeseals.me</title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    <meta name="robots" content="noodp"/>

    <link rel="stylesheet" href="https://blog.wipeseals.me/style.css">
    <link rel="stylesheet" href="https://blog.wipeseals.me/color/blue-light.css">

        <link rel="stylesheet" href="https://blog.wipeseals.me/color/background_light.css">
    
    <link rel="stylesheet" href="https://blog.wipeseals.me/font-hack.css">

    <meta name="description" content="Miscellaneous logs...">

    <meta property="og:description" content="Miscellaneous logs...">
    <meta property="og:title" content="blog.wipeseals.me">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://blog.wipeseals.me/">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:description" content="Miscellaneous logs...">
    <meta name="twitter:title" content="blog.wipeseals.me">
    <meta property="twitter:domain" content="blog.wipeseals.me">
    <meta property="twitter:url" content="https://blog.wipeseals.me/">

        <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">
    
    </head>

<body class="">
<div class="container">
    
    <header class="header">
        <div class="header__inner">
            <div class="header__logo">
                    
                <a href="/" style="text-decoration: none;">
                    <div class="logo">
                      
                            blog.wipeseals.me
                        
                    </div>
                </a>
            </div>
        </div>

        
        
                <nav class="menu">
            <ul class="menu__inner">
                <li class="active"><a href="https://blog.wipeseals.me">blog</a></li>
            
                <li><a href="https://blog.wipeseals.me/tags">tags</a></li>
            
                <li><a href="https://blog.wipeseals.me/archive">archive</a></li>
            
                <li><a href="https://blog.wipeseals.me/work">work</a></li>
            
                <li><a href="https://wipeseals.me">about</a></li>
            
                <li><a href="https://github.com/wipeseals" target="_blank" rel="noopener noreferrer">github</a></li>
            </ul>
        </nav>
    
    
        
    </header>
    

    <div class="content">
        
        <div class="posts">
                <div class="post on-list">
                    
    <h1 class="post-title"><a href="https://blog.wipeseals.me/blog/2025/rpi-pico-pio-dma/">RPi Pico PIO + DMA 転送覚書 (MicroPython 版)</a></h1>
    <div class="post-meta-inline">
        
    <span class="post-date">
            2025-06-03
        </span>

    </div>

    
        <span class="post-tags-inline">
                :: tags:&nbsp;
                <a class="post-tag" href="https://blog.wipeseals.me/tags/dma/">#dma</a>&nbsp;
                <a class="post-tag" href="https://blog.wipeseals.me/tags/embedded/">#embedded</a>&nbsp;
                <a class="post-tag" href="https://blog.wipeseals.me/tags/micropython/">#micropython</a>&nbsp;
                <a class="post-tag" href="https://blog.wipeseals.me/tags/pio/">#pio</a>&nbsp;
                <a class="post-tag" href="https://blog.wipeseals.me/tags/raspberrypi/">#raspberrypi</a></span>
    


                    <div class="post-content">
            <p>MicroPython を用いて Raspberry Pi Pico の PIO と DMA を使う方法についての覚書。それぞれの情報は入手できるが、TX_FIFO/RX_FIFO 両方に DMA する例がなかったので書き残す。</p>
<p>本内容は MicroPython のドキュメント並びに RP2040 の仕様書から抜粋した内容となっている。</p>
<h2 id="hw-shang-da-cheng-subekikoto">HW 上達成すべきこと</h2>
<p><code>PIOx_BASE</code> + <code>(T|R)XFy</code> のアドレスに読み書きを行うこと。</p>
<p>以下内容より PIO Address <code>x= (0|1)</code> と
<code>(T|R)XFy</code> のアドレス <code>y= (0|1|2|3)</code> を組み合わせて、PIO の TX_FIFO/RX_FIFO にアクセスする。</p>
<h3 id="piox-base"><code>PIOx_BASE</code></h3>
<p><code>PIOx_BASE</code> は、PIO の Base Address。 2.2. Address Map にて以下定義がなされている。</p>
<ul>
<li><code>PIO0_BASE</code> = <code>0x50200000</code></li>
<li><code>PIO1_BASE</code> = <code>0x50300000</code></li>
</ul>
<h3 id="t-r-xfy"><code>(T|R)XFy</code></h3>
<p><code>(T|R)XFy</code> は、PIO の TX_FIFO/RX_FIFO のレジスタ。Chapter 3. PIO 3.7. List of Registers にて以下定義がなされている。</p>
<table><thead><tr><th>Offset</th><th>Name</th></tr></thead><tbody>
<tr><td>0x010</td><td><code>TXF0</code></td></tr>
<tr><td>0x014</td><td><code>TXF1</code></td></tr>
<tr><td>0x018</td><td><code>TXF2</code></td></tr>
<tr><td>0x01C</td><td><code>TXF3</code></td></tr>
<tr><td>0x020</td><td><code>RXF0</code></td></tr>
<tr><td>0x024</td><td><code>RXF1</code></td></tr>
<tr><td>0x028</td><td><code>RXF2</code></td></tr>
<tr><td>0x02C</td><td><code>RXF3</code></td></tr>
</tbody></table>
<p>FIFO の空きに関連する情報は Offset 0x008 <code>FDEBUG</code> レジスタの <code>TXSTALL</code>, <code>TXOVER</code>, <code>RXUNDER</code>, <code>RXSTALL</code> 及び FLEVEL の <code>(T|R)Xy</code>から確認できる。</p>
<h3 id="dma-niokeru-fifo-status-noque-ren">DMA における FIFO Status の確認</h3>
<p>DMA が一方的にデータ転送しても FIFO にデータがないのに読み出したり、あるのに書き込んで溢れてしまう。これを防ぐため、ペリフェラル（ここでは PIO）のペースでデータ転送を行えるようなしくみがあり、 Data Request (DREQ) と呼ばれる設定を行う。</p>
<p>2.5.3.1 System DREQ Table の設定があり、PIO に関連する内容は以下のようになっている。</p>
<p><code>DREQ# = PIO# * 4 + (4 if RX else 0) + SM#</code></p>
<table><thead><tr><th>PIO</th><th>SM</th><th>PORT</th><th>DREQ#</th><th>Description</th></tr></thead><tbody>
<tr><td>0</td><td>0</td><td>TX</td><td>0</td><td>PIO0 SM0 TX DREQ</td></tr>
<tr><td>0</td><td>0</td><td>TX</td><td>1</td><td>PIO0 SM1 TX DREQ</td></tr>
<tr><td>0</td><td>0</td><td>TX</td><td>2</td><td>PIO0 SM2 TX DREQ</td></tr>
<tr><td>0</td><td>0</td><td>TX</td><td>3</td><td>PIO0 SM3 TX DREQ</td></tr>
<tr><td>0</td><td>0</td><td>RX</td><td>4</td><td>PIO0 SM0 RX DREQ</td></tr>
<tr><td>0</td><td>0</td><td>RX</td><td>5</td><td>PIO0 SM1 RX DREQ</td></tr>
<tr><td>0</td><td>0</td><td>RX</td><td>6</td><td>PIO0 SM2 RX DREQ</td></tr>
<tr><td>0</td><td>0</td><td>RX</td><td>7</td><td>PIO0 SM3 RX DREQ</td></tr>
<tr><td>1</td><td>0</td><td>TX</td><td>8</td><td>PIO1 SM0 TX DREQ</td></tr>
<tr><td>1</td><td>0</td><td>TX</td><td>9</td><td>PIO1 SM1 TX DREQ</td></tr>
<tr><td>1</td><td>0</td><td>TX</td><td>10</td><td>PIO1 SM2 TX DREQ</td></tr>
<tr><td>1</td><td>0</td><td>TX</td><td>11</td><td>PIO1 SM3 TX DREQ</td></tr>
<tr><td>1</td><td>0</td><td>RX</td><td>12</td><td>PIO1 SM0 RX DREQ</td></tr>
<tr><td>1</td><td>0</td><td>RX</td><td>13</td><td>PIO1 SM1 RX DREQ</td></tr>
<tr><td>1</td><td>0</td><td>RX</td><td>14</td><td>PIO1 SM2 RX DREQ</td></tr>
<tr><td>1</td><td>0</td><td>RX</td><td>15</td><td>PIO1 SM3 RX DREQ</td></tr>
</tbody></table>
<h2 id="micropython-denoshi-zhuang">MicroPython での実装</h2>
<p>DMA class, PIO class, StateMachine class を使って、PIO の TX_FIFO/RX_FIFO に DMA 転送を行う。</p>
<p>入力されたデータを Echo する PIO プログラムを実行し、TX_FIFO と RX_FIFO の両方に DMA 転送を行う例を示す。</p>
<pre data-lang="python" style="background-color:#ffffff;color:#010101;" class="language-python "><code class="language-python" data-lang="python"><span style="color:#898989;"># 送受信するデータ
</span><span>tx_data </span><span style="color:#016692;">= </span><span>array.</span><span style="color:#696989;">array</span><span>(</span><span style="color:#009f78;">&quot;I&quot;</span><span>, [</span><span style="color:#8c008a;">0x12345678</span><span>, </span><span style="color:#8c008a;">0x9ABCDEF0</span><span>, </span><span style="color:#8c008a;">0xDEADBEEF</span><span>, </span><span style="color:#8c008a;">0xFEEDFACE</span><span>]) </span><span style="color:#898989;"># test data
</span><span>rx_data </span><span style="color:#016692;">= </span><span>array.</span><span style="color:#696989;">array</span><span>(</span><span style="color:#009f78;">&quot;I&quot;</span><span>, [</span><span style="color:#8c008a;">0</span><span>] </span><span style="color:#016692;">* </span><span style="color:#7a7025;">len</span><span>(tx_data))
</span><span>
</span><span>
</span><span style="color:#898989;"># PIO プログラムの定義
</span><span>@rp2.</span><span style="color:#696989;">asm_pio</span><span>(
</span><span>    </span><span style="color:#898989;"># out, sideset, shift方向, autopush等の設定がここで行える
</span><span>)
</span><span style="color:#016692;">def </span><span style="color:#a15001;">pio_echoback</span><span>():
</span><span>    </span><span style="color:#898989;"># PIO asm本体。ここではTX_FIFOの内容をRX_FIFOにそのまま返す
</span><span>    </span><span style="color:#696989;">wrap_target</span><span>()
</span><span>    </span><span style="color:#696989;">pull</span><span>(block)
</span><span>    </span><span style="color:#696989;">out</span><span>(x, </span><span style="color:#8c008a;">32</span><span>)
</span><span>    </span><span style="color:#696989;">in_</span><span>(x, </span><span style="color:#8c008a;">32</span><span>)
</span><span>    </span><span style="color:#696989;">push</span><span>(block)
</span><span>    </span><span style="color:#696989;">wrap</span><span>()
</span><span>
</span><span style="color:#898989;"># PIO0 State Machine 0を起動
</span><span>sm0 </span><span style="color:#016692;">= </span><span>rp2.</span><span style="color:#696989;">StateMachine</span><span>(</span><span style="color:#8c008a;">0</span><span>)
</span><span>sm0.</span><span style="color:#696989;">init</span><span>(
</span><span>    </span><span style="color:#696989;">prog</span><span style="color:#016692;">=</span><span>pio_echoback,
</span><span>    </span><span style="color:#696989;">freq</span><span style="color:#016692;">=</span><span style="color:#8c008a;">125_000_000</span><span>,  </span><span style="color:#898989;"># 125MHz
</span><span>    </span><span style="color:#898989;"># pin設定, 周波数設定等の設定が行える
</span><span>)
</span><span>sm0.</span><span style="color:#696989;">active</span><span>(</span><span style="color:#8c008a;">1</span><span>)
</span><span>
</span><span>
</span><span style="color:#898989;"># Setup TX DMA
</span><span>tx_dma0 </span><span style="color:#016692;">= </span><span>rp2.</span><span style="color:#696989;">DMA</span><span>()
</span><span>tx_dma0_ctrl </span><span style="color:#016692;">= </span><span>tx_dma0.</span><span style="color:#696989;">pack_ctrl</span><span>(
</span><span>    </span><span style="color:#696989;">size</span><span style="color:#016692;">=</span><span style="color:#8c008a;">2</span><span>,  </span><span style="color:#898989;"># 0=1byte, 1=2byte, 2=4byte転送
</span><span>    </span><span style="color:#696989;">inc_read</span><span style="color:#016692;">=</span><span style="color:#333366;">True</span><span>,
</span><span>    </span><span style="color:#696989;">inc_write</span><span style="color:#016692;">=</span><span style="color:#333366;">False</span><span>,  </span><span style="color:#898989;"># PIO0 TXF0は場所固定なのでincrementしない
</span><span>    </span><span style="color:#696989;">treq_sel</span><span style="color:#016692;">=</span><span style="color:#8c008a;">0</span><span>,  </span><span style="color:#898989;"># PIO0 SM0 TX DREQ
</span><span>)
</span><span>tx_dma0.</span><span style="color:#696989;">config</span><span>(
</span><span>    </span><span style="color:#696989;">read</span><span style="color:#016692;">=</span><span>tx_data,  </span><span style="color:#898989;"># 転送元データをそのまま渡す
</span><span>    </span><span style="color:#696989;">write</span><span style="color:#016692;">=</span><span>sm0,  </span><span style="color:#898989;"># state machine をそのまま渡す
</span><span>    </span><span style="color:#696989;">count</span><span style="color:#016692;">=</span><span style="color:#7a7025;">len</span><span>(
</span><span>        tx_data
</span><span>    ),  </span><span style="color:#898989;"># 転送byte数ではなく、pack_ctrlのsizeで指定した単位での転送数なので注意
</span><span>    </span><span style="color:#696989;">ctrl</span><span style="color:#016692;">=</span><span>tx_dma0_ctrl,
</span><span>    </span><span style="color:#696989;">trigger</span><span style="color:#016692;">=</span><span style="color:#333366;">True</span><span>,  </span><span style="color:#898989;"># 開始
</span><span>)
</span><span>
</span><span style="color:#898989;"># Setup RX DMA
</span><span>rx_dma0 </span><span style="color:#016692;">= </span><span>rp2.</span><span style="color:#696989;">DMA</span><span>()
</span><span>rx_dma0_ctrl </span><span style="color:#016692;">= </span><span>rx_dma0.</span><span style="color:#696989;">pack_ctrl</span><span>(
</span><span>    </span><span style="color:#696989;">size</span><span style="color:#016692;">=</span><span style="color:#8c008a;">2</span><span>,  </span><span style="color:#898989;"># 0=1byte, 1=2byte, 2=4byte転送
</span><span>    </span><span style="color:#696989;">inc_read</span><span style="color:#016692;">=</span><span style="color:#333366;">False</span><span>,  </span><span style="color:#898989;"># PIO0 RXF0は場所固定なのでincrementしない
</span><span>    </span><span style="color:#696989;">inc_write</span><span style="color:#016692;">=</span><span style="color:#333366;">True</span><span>,
</span><span>    </span><span style="color:#696989;">treq_sel</span><span style="color:#016692;">=</span><span style="color:#8c008a;">4</span><span>,  </span><span style="color:#898989;"># PIO0 SM0 RX DREQ
</span><span>)
</span><span>rx_dma0.</span><span style="color:#696989;">config</span><span>(
</span><span>    </span><span style="color:#696989;">read</span><span style="color:#016692;">=</span><span>sm0,  </span><span style="color:#898989;"># state machine をそのまま渡す
</span><span>    </span><span style="color:#696989;">write</span><span style="color:#016692;">=</span><span>rx_data,  </span><span style="color:#898989;"># 転送先データをそのまま渡す
</span><span>    </span><span style="color:#696989;">count</span><span style="color:#016692;">=</span><span style="color:#7a7025;">len</span><span>(
</span><span>        tx_data
</span><span>    ),  </span><span style="color:#898989;"># 転送byte数ではなく、pack_ctrlのsizeで指定した単位での転送数なので注意
</span><span>    </span><span style="color:#696989;">ctrl</span><span style="color:#016692;">=</span><span>rx_dma0_ctrl,
</span><span>    </span><span style="color:#696989;">trigger</span><span style="color:#016692;">=</span><span style="color:#333366;">True</span><span>,
</span><span>)
</span><span>
</span><span style="color:#898989;"># 転送完了待ち
</span><span style="color:#016692;">while </span><span>rx_dma0.</span><span style="color:#696989;">active</span><span>():
</span><span>    </span><span style="color:#016692;">pass
</span><span>
</span><span style="color:#898989;"># 結果確認
</span><span style="color:#016692;">for </span><span>i </span><span style="color:#016692;">in </span><span style="color:#7a7025;">range</span><span>(</span><span style="color:#7a7025;">len</span><span>(rx_data)):
</span><span>    </span><span style="color:#7a7025;">print</span><span>(</span><span style="color:#877611;">f</span><span style="color:#009f78;">&quot;TX Data[</span><span>{i}</span><span style="color:#009f78;">]: </span><span>{tx_data[i]</span><span style="color:#333366;">:#010x</span><span>}</span><span style="color:#009f78;">, RX Data[</span><span>{i}</span><span style="color:#009f78;">]: </span><span>{rx_data[i]</span><span style="color:#333366;">:#010x</span><span>}</span><span style="color:#009f78;">&quot;</span><span>)
</span><span>    </span><span style="color:#016692;">assert </span><span>tx_data[i] </span><span style="color:#016692;">== </span><span>rx_data[i], (
</span><span>        </span><span style="color:#877611;">f</span><span style="color:#009f78;">&quot;Data mismatch at index </span><span>{i}</span><span style="color:#009f78;">: </span><span>{tx_data[i]</span><span style="color:#333366;">:#010x</span><span>}</span><span style="color:#009f78;"> != </span><span>{rx_data[i]</span><span style="color:#333366;">:#010x</span><span>}</span><span style="color:#009f78;">&quot;
</span><span>    )
</span><span>
</span><span style="color:#898989;"># 終了処理
</span><span>sm0.</span><span style="color:#696989;">active</span><span>(</span><span style="color:#8c008a;">0</span><span>)
</span><span>tx_dma0.</span><span style="color:#696989;">close</span><span>()
</span><span>rx_dma0.</span><span style="color:#696989;">close</span><span>()
</span></code></pre>
<p>出力</p>
<pre data-lang="log" style="background-color:#ffffff;color:#010101;" class="language-log "><code class="language-log" data-lang="log"><span>TX Data[0]: 0x12345678, RX Data[0]: 0x12345678
</span><span>TX Data[1]: 0x9abcdef0, RX Data[1]: 0x9abcdef0
</span><span>TX Data[2]: 0xdeadbeef, RX Data[2]: 0xdeadbeef
</span><span>TX Data[3]: 0xfeedface, RX Data[3]: 0xfeedface
</span></code></pre>
<h2 id="tips">Tips</h2>
<h3 id="byteswap-sitai">byteswap したい</h3>
<p>pio program 中でエンディアンが入れ替わってしまうケースなどを想定。BSWAP option があり、これは DMA の設定で行える</p>
<pre data-lang="python" style="background-color:#ffffff;color:#010101;" class="language-python "><code class="language-python" data-lang="python"><span style="color:#898989;"># Setup RX DMA
</span><span>rx_dma0 </span><span style="color:#016692;">= </span><span>rp2.</span><span style="color:#696989;">DMA</span><span>()
</span><span>rx_dma0_ctrl </span><span style="color:#016692;">= </span><span>rx_dma0.</span><span style="color:#696989;">pack_ctrl</span><span>(
</span><span>    </span><span style="color:#696989;">size</span><span style="color:#016692;">=</span><span style="color:#8c008a;">2</span><span>,  </span><span style="color:#898989;"># 0=1byte, 1=2byte, 2=4byte転送
</span><span>    </span><span style="color:#696989;">inc_read</span><span style="color:#016692;">=</span><span style="color:#333366;">False</span><span>,  </span><span style="color:#898989;"># PIO0 RXF0は場所固定なのでincrementしない
</span><span>    </span><span style="color:#696989;">inc_write</span><span style="color:#016692;">=</span><span style="color:#333366;">True</span><span>,
</span><span>    </span><span style="color:#696989;">bswap</span><span style="color:#016692;">=</span><span style="color:#333366;">True</span><span>,  </span><span style="color:#898989;"># 受信データはBig Endianなので、バイトオーダーを反転
</span><span>    </span><span style="color:#696989;">treq_sel</span><span style="color:#016692;">=</span><span style="color:#8c008a;">4</span><span>,  </span><span style="color:#898989;"># PIO0 SM0 RX DREQ
</span><span>)
</span></code></pre>
<p>実行結果</p>
<pre data-lang="log" style="background-color:#ffffff;color:#010101;" class="language-log "><code class="language-log" data-lang="log"><span>TX Data[0]: 0x12345678, RX Data[0]: 0x78563412
</span><span>Traceback (most recent call last):
</span><span>  File &quot;&lt;stdin&gt;&quot;, line 444, in &lt;module&gt;
</span><span>AssertionError: Data mismatch at index 0: 0x12345678 != 0x78563412
</span></code></pre>
<h3 id="1byte-zutuzhuan-song-sitai">1byte ずつ転送したい</h3>
<p><code>size=0</code> を指定することで、1byte ずつ転送できる。転送カウント数に注意</p>
<pre data-lang="python" style="background-color:#ffffff;color:#010101;" class="language-python "><code class="language-python" data-lang="python"><span style="color:#898989;"># Setup TX DMA
</span><span>tx_dma0 </span><span style="color:#016692;">= </span><span>rp2.</span><span style="color:#696989;">DMA</span><span>()
</span><span>tx_dma0_ctrl </span><span style="color:#016692;">= </span><span>tx_dma0.</span><span style="color:#696989;">pack_ctrl</span><span>(
</span><span>    </span><span style="color:#696989;">size</span><span style="color:#016692;">=</span><span style="color:#8c008a;">0</span><span>,  </span><span style="color:#898989;"># 0=1byte, 1=2byte, 2=4byte転送
</span><span>    </span><span style="color:#696989;">inc_read</span><span style="color:#016692;">=</span><span style="color:#333366;">True</span><span>,
</span><span>    </span><span style="color:#696989;">inc_write</span><span style="color:#016692;">=</span><span style="color:#333366;">False</span><span>,  </span><span style="color:#898989;"># PIO0 TXF0は場所固定なのでincrementしない
</span><span>    </span><span style="color:#696989;">treq_sel</span><span style="color:#016692;">=</span><span style="color:#8c008a;">0</span><span>,  </span><span style="color:#898989;"># PIO0 SM0 TX DREQ
</span><span>)
</span><span>tx_dma0.</span><span style="color:#696989;">config</span><span>(
</span><span>    </span><span style="color:#696989;">read</span><span style="color:#016692;">=</span><span>tx_data,  </span><span style="color:#898989;"># 転送元データをそのまま渡す
</span><span>    </span><span style="color:#696989;">write</span><span style="color:#016692;">=</span><span>sm0,  </span><span style="color:#898989;"># state machine をそのまま渡す
</span><span>    </span><span style="color:#696989;">count</span><span style="color:#016692;">=</span><span style="color:#7a7025;">len</span><span>(tx_data) </span><span style="color:#016692;">* </span><span style="color:#8c008a;">4</span><span>,  </span><span style="color:#898989;"># 転送byte数ではなく、pack_ctrlのsizeで指定した単位での転送数なので注意
</span><span>    </span><span style="color:#696989;">ctrl</span><span style="color:#016692;">=</span><span>tx_dma0_ctrl,
</span><span>    </span><span style="color:#696989;">trigger</span><span style="color:#016692;">=</span><span style="color:#333366;">True</span><span>,  </span><span style="color:#898989;"># 開始
</span><span>)
</span><span>
</span><span style="color:#898989;"># RX側も同様に修正
</span></code></pre>
<p>結果</p>
<pre data-lang="log" style="background-color:#ffffff;color:#010101;" class="language-log "><code class="language-log" data-lang="log"><span>TX Data[0]: 0x12345678, RX Data[0]: 0x12345678
</span><span>TX Data[1]: 0x9abcdef0, RX Data[1]: 0x9abcdef0
</span><span>TX Data[2]: 0xdeadbeef, RX Data[2]: 0xdeadbeef
</span><span>TX Data[3]: 0xfeedface, RX Data[3]: 0xfeedface
</span></code></pre>
<h3 id="sniff-sitai-chain-sitai">sniff したい、chain したい、...</h3>
<p><code>DMA.pack_ctrl()</code> や園周辺を読むと概ねやりたいことは記載があるはず。先に示した例を下に改造・改良していくことを推奨。</p>
<p><a href="https://micropython-docs-ja.readthedocs.io/ja/latest/library/rp2.DMA.html#rp2.DMA.pack_ctrl">MicroPython library - rp2.DMA</a></p>
<h2 id="zhong-warini">終わりに</h2>
<p><code>DMA.config</code> の <code>read</code>, <code>write</code> に Peripheral が来るケースでの指定がいまいち読み取りづらかったので書き残した。</p>
<h2 id="reference">Reference</h2>
<ul>
<li><a href="https://micropython-docs-ja.readthedocs.io/ja/latest/library/rp2.html">MicroPython library - rp2</a></li>
<li><a href="https://datasheets.raspberrypi.com/rp2040/rp2040-datasheet.pdf">RP2040 Datasheet</a></li>
</ul>

        </div>

                </div>
            
                <div class="post on-list">
                    
    <h1 class="post-title"><a href="https://blog.wipeseals.me/blog/2025/build-riscv-tests-on-docker/">Docker で riscv-tests をビルドする</a></h1>
    <div class="post-meta-inline">
        
    <span class="post-date">
            2025-02-26
        </span>

    </div>

    
        <span class="post-tags-inline">
                :: tags:&nbsp;
                <a class="post-tag" href="https://blog.wipeseals.me/tags/docker/">#Docker</a>&nbsp;
                <a class="post-tag" href="https://blog.wipeseals.me/tags/riscv/">#riscv</a>&nbsp;
                <a class="post-tag" href="https://blog.wipeseals.me/tags/tech/">#tech</a></span>
    


                    <div class="post-content">
            <p>(ビルドが長くて) 地味に時間がかかったので、今後時間を溶かさないように書き残す。</p>
<h2 id="shou-shun">手順</h2>
<h3 id="dockerfile-de-riscv-gnu-toolchain-huan-jing-woyong-yi">Dockerfile で riscv-gnu-toolchain 環境を用意</h3>
<p>これはほぼ公式手順を Dockerfile に書き起こすだけで良い。<code>ARCH</code>, <code>ABI</code> などは好みのものに変更する。</p>
<pre data-lang="Dockerfile" style="background-color:#ffffff;color:#010101;" class="language-Dockerfile "><code class="language-Dockerfile" data-lang="Dockerfile"><span style="color:#016692;">FROM</span><span> ubuntu:</span><span style="color:#a15001;">24.04
</span><span>
</span><span style="color:#016692;">WORKDIR </span><span>/app
</span><span>
</span><span style="color:#898989;"># riscv-gnu-toolchainのリポジトリを取得
</span><span style="color:#016692;">RUN </span><span>apt update &amp;&amp; apt install -y git
</span><span style="color:#016692;">RUN </span><span>git clone --recursive https://github.com/riscv/riscv-gnu-toolchain
</span><span>
</span><span style="color:#016692;">ENV </span><span>RISCV=/opt/riscv
</span><span style="color:#016692;">ENV </span><span>ARCH=rv32ima
</span><span style="color:#016692;">ENV </span><span>ABI=ilp32
</span><span style="color:#016692;">ENV </span><span>PATH=$RISCV/bin:$PATH
</span><span style="color:#016692;">ENV </span><span>TOOLCHAIN_CONFIGURE=</span><span style="color:#009f78;">&quot;--prefix=$RISCV --with-arch=$ARCH --with-abi=$ABI --enable-multilib --enable-qemu-system&quot;
</span><span style="color:#016692;">ENV </span><span>DEBIAN_FRONTEND=noninteractive
</span><span>
</span><span style="color:#898989;"># 必要なパッケージをインストール
</span><span style="color:#016692;">RUN </span><span>apt install -y \
</span><span>    autoconf \
</span><span>    automake \
</span><span>    autotools-dev \
</span><span>    curl \
</span><span>    python3 \
</span><span>    python3-pip \
</span><span>    python3-tomli \
</span><span>    libmpc-dev \
</span><span>    libmpfr-dev \
</span><span>    libgmp-dev \
</span><span>    gawk \
</span><span>    build-essential \
</span><span>    bison \
</span><span>    flex \
</span><span>    texinfo \
</span><span>    gperf \
</span><span>    libtool \
</span><span>    patchutils \
</span><span>    bc \
</span><span>    zlib1g-dev \
</span><span>    libexpat-dev \
</span><span>    ninja-build \
</span><span>    git \
</span><span>    cmake \
</span><span>    libglib2.0-dev \
</span><span>    libslirp-dev
</span><span>
</span><span style="color:#898989;"># riscv-gnu-toolchainのインストール
</span><span style="color:#016692;">RUN </span><span>cd riscv-gnu-toolchain &amp;&amp; \
</span><span>    ./configure $TOOLCHAIN_CONFIGURE &amp;&amp; \
</span><span>    make -j$(nproc)
</span><span>
</span><span style="color:#016692;">CMD </span><span>[</span><span style="color:#009f78;">&quot;bash&quot;</span><span>]
</span></code></pre>
<h3 id="shang-ji-dockerfile-woshi-tute-riscv-tests-wobirudo">上記 Dockerfile を使って riscv-tests をビルド</h3>
<p>multi-stage build で riscv-tests を行っても良かったが、単にビルドするだけであること、自分が実装した別ソースをビルドすることなどを考え先の Image を利用するだけに留めることにした。</p>
<p>docker compose を用意し、成果物 Volume のマウント並びにビルドのワンライナーを用意する。
実装してある内容は riscv-tests の README 通りだが、今回は rv32 を対象にしているので XLEN を設定していること、ISA テスト用に make 対象を isa に絞っている。</p>
<pre data-lang="yaml" style="background-color:#ffffff;color:#010101;" class="language-yaml "><code class="language-yaml" data-lang="yaml"><span style="color:#00528b;">services</span><span>:
</span><span>  </span><span style="color:#00528b;">build-riscv-tests</span><span>:
</span><span>    </span><span style="color:#00528b;">build</span><span>:
</span><span>      </span><span style="color:#00528b;">context</span><span>: </span><span style="color:#8c008a;">.
</span><span>    </span><span style="color:#00528b;">volumes</span><span>:
</span><span>      - </span><span style="color:#009f78;">./riscv-tests:/app/riscv-tests:rw
</span><span>    </span><span style="color:#00528b;">command</span><span>: </span><span style="color:#016692;">&gt;
</span><span style="color:#009f78;">      bash -c &quot;
</span><span style="color:#009f78;">      cd /app/riscv-tests &amp;&amp; 
</span><span style="color:#009f78;">      git clone --recursive https://github.com/riscv/riscv-tests &amp;&amp; 
</span><span style="color:#009f78;">      cd riscv-tests &amp;&amp; 
</span><span style="color:#009f78;">      autoconf &amp;&amp; 
</span><span style="color:#009f78;">      ./configure --prefix=$RISCV/target &amp;&amp; 
</span><span style="color:#009f78;">      make XLEN=32 isa
</span><span style="color:#009f78;">      &quot;
</span></code></pre>
<p>使い方</p>
<pre data-lang="bash" style="background-color:#ffffff;color:#010101;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#696989;">docker</span><span> compose run build-riscv-tests
</span></code></pre>
<h2 id="sonota">その他</h2>
<h3 id="riscv-gnu-toolchain-nosonota-noturuwoshi-itai">riscv-gnu-toolchain のその他のツールを使いたい</h3>
<p><code>docker compose run build-riscv-tests bash</code> で入った環境であれば、他のツールも使える。</p>
<pre data-lang="bash" style="background-color:#ffffff;color:#010101;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#696989;">$</span><span> docker compose run build-riscv-tests bash
</span><span style="color:#696989;">root@460560b02bb5:/app#</span><span> riscv32-unknown-elf-readelf</span><span style="color:#696989;"> -e -W</span><span> riscv-tests/isa/rv32ui-p-addi
</span><span style="color:#696989;">ELF</span><span> Header:
</span><span>  </span><span style="color:#696989;">Magic:</span><span>   7f 45 4c 46 01 01 01 00 00 00 00 00 00 00 00 00
</span><span>  </span><span style="color:#696989;">Class:</span><span>                             ELF32
</span><span>  </span><span style="color:#696989;">Data:</span><span>                              2</span><span style="color:#009f78;">&#39;s complement, little endian
</span><span style="color:#009f78;">  Version:                           1 (current)
</span><span style="color:#009f78;">  OS/ABI:                            UNIX - System V
</span><span style="color:#009f78;">  ABI Version:                       0
</span><span style="color:#009f78;">  Type:                              EXEC (Executable file)
</span><span style="color:#009f78;">  Machine:                           RISC-V
</span><span style="color:#009f78;">  Version:                           0x1
</span><span style="color:#009f78;">  Entry point address:               0x80000000
</span><span style="color:#009f78;">  Start of program headers:          52 (bytes into file)
</span><span style="color:#009f78;">  Start of section headers:          9524 (bytes into file)
</span><span style="color:#009f78;">  Flags:                             0x0
</span><span style="color:#009f78;">  Size of this header:               52 (bytes)
</span><span style="color:#009f78;">  Size of program headers:           32 (bytes)
</span><span style="color:#009f78;">  Number of program headers:         3
</span><span style="color:#009f78;">  Size of section headers:           40 (bytes)
</span><span style="color:#009f78;">  Number of section headers:         7
</span><span style="color:#009f78;">  Section header string table index: 6
</span><span style="color:#009f78;">
</span><span style="color:#009f78;">Section Headers:
</span><span style="color:#009f78;">  [Nr] Name              Type            Addr     Off    Size   ES Flg Lk Inf Al
</span><span style="color:#009f78;">  [ 0]                   NULL            00000000 000000 000000 00      0   0  0
</span><span style="color:#009f78;">  [ 1] .text.init        PROGBITS        80000000 001000 00047c 00  AX  0   0 64
</span><span style="color:#009f78;">  [ 2] .tohost           PROGBITS        80001000 002000 000048 00  WA  0   0 64
</span><span style="color:#009f78;">  [ 3] .riscv.attributes RISCV_ATTRIBUTES 00000000 002048 000063 00      0   0  1
</span><span style="color:#009f78;">  [ 4] .symtab           SYMTAB          00000000 0020ac 0002b0 10      5  37  4
</span><span style="color:#009f78;">  [ 5] .strtab           STRTAB          00000000 00235c 000198 00      0   0  1
</span><span style="color:#009f78;">  [ 6] .shstrtab         STRTAB          00000000 0024f4 000040 00      0   0  1
</span><span style="color:#009f78;">Key to Flags:
</span><span style="color:#009f78;">  W (write), A (alloc), X (execute), M (merge), S (strings), I (info),
</span><span style="color:#009f78;">  L (link order), O (extra OS processing required), G (group), T (TLS),
</span><span style="color:#009f78;">  C (compressed), x (unknown), o (OS specific), E (exclude),
</span><span style="color:#009f78;">  D (mbind), p (processor specific)
</span><span style="color:#009f78;">
</span><span style="color:#009f78;">Program Headers:
</span><span style="color:#009f78;">  Type           Offset   VirtAddr   PhysAddr   FileSiz MemSiz  Flg Align
</span><span style="color:#009f78;">  RISCV_ATTRIBUT 0x002048 0x00000000 0x00000000 0x00063 0x00000 R   0x1
</span><span style="color:#009f78;">  LOAD           0x001000 0x80000000 0x80000000 0x0047c 0x0047c R E 0x1000
</span><span style="color:#009f78;">  LOAD           0x002000 0x80001000 0x80001000 0x00048 0x00048 RW  0x1000
</span><span style="color:#009f78;">
</span><span style="color:#009f78;"> Section to Segment mapping:
</span><span style="color:#009f78;">  Segment Sections...
</span><span style="color:#009f78;">   00     .riscv.attributes
</span><span style="color:#009f78;">   01     .text.init
</span><span style="color:#009f78;">   02     .tohost
</span></code></pre>
<h3 id="rv64-32-noxuan-ze">RV64/32 の選択</h3>
<ul>
<li>Dockerfile の <code>ARCH</code> と <code>ABI</code> を変更する</li>
<li>make 時の <code>XLEN</code> を変更する
<ul>
<li>riscv-tests のデフォルトは <code>XLEN=64</code> を使おうとしているので、rv32 向けの toolchain だと gcc などが見つからずエラーになる</li>
</ul>
</li>
</ul>
<h3 id="linker-script-noxiu-zheng">Linker script の修正</h3>
<p><a href="https://github.com/riscv/riscv-test-env">riscv-tests/env が更に submodule になっており</a>、ここを修正することで対応できる。
例えば <code>p/link.ld</code> は以下の具合</p>
<pre data-lang="ld" style="background-color:#ffffff;color:#010101;" class="language-ld "><code class="language-ld" data-lang="ld"><span style="color:#696989;">OUTPUT_ARCH</span><span>( </span><span style="color:#696989;">&quot;riscv&quot;</span><span> )
</span><span style="color:#016692;">ENTRY</span><span>(</span><span style="color:#696989;">_start</span><span>)
</span><span>
</span><span style="color:#016692;">SECTIONS
</span><span>{
</span><span>  </span><span style="color:#696989;">.</span><span> = </span><span style="color:#8c008a;">0x80000000</span><span>;
</span><span>  </span><span style="color:#696989;">.text.init</span><span> : { *(</span><span style="color:#696989;">.text.init</span><span>) }
</span><span>  </span><span style="color:#696989;">.</span><span> = </span><span style="color:#016692;">ALIGN</span><span>(</span><span style="color:#8c008a;">0x1000</span><span>);
</span><span>  </span><span style="color:#696989;">.tohost</span><span> : { *(</span><span style="color:#696989;">.tohost</span><span>) }
</span><span>  </span><span style="color:#696989;">.</span><span> = </span><span style="color:#016692;">ALIGN</span><span>(</span><span style="color:#8c008a;">0x1000</span><span>);
</span><span>  </span><span style="color:#696989;">.text</span><span> : { *(</span><span style="color:#696989;">.text</span><span>) }
</span><span>  </span><span style="color:#696989;">.</span><span> = </span><span style="color:#016692;">ALIGN</span><span>(</span><span style="color:#8c008a;">0x1000</span><span>);
</span><span>  </span><span style="color:#696989;">.data</span><span> : { *(</span><span style="color:#696989;">.data</span><span>) }
</span><span>  </span><span style="color:#696989;">.bss</span><span> : { *(</span><span style="color:#696989;">.bss</span><span>) }
</span><span>  </span><span style="color:#696989;">_end</span><span> = </span><span style="color:#696989;">.</span><span>;
</span><span>}
</span></code></pre>
<p>この他にも <code>riscv_test.h</code> にテストの各マクロの定義があるので、動作確認向けに変更することもできる。
例えば Pass/Fail は、Pass の場合</p>
<pre data-lang="c" style="background-color:#ffffff;color:#010101;" class="language-c "><code class="language-c" data-lang="c"><span style="color:#898989;">//-----------------------------------------------------------------------
</span><span style="color:#898989;">// Pass/Fail Macro
</span><span style="color:#898989;">//-----------------------------------------------------------------------
</span><span>
</span><span style="color:#016692;">#define </span><span style="color:#a15001;">RVTEST_PASS                                                     </span><span>\
</span><span>        fence;                                                          \
</span><span>        li TESTNUM, </span><span style="color:#8c008a;">1</span><span>;                                                  \
</span><span>        li a7, </span><span style="color:#8c008a;">93</span><span>;                                                      \
</span><span>        li a0, </span><span style="color:#8c008a;">0</span><span>;                                                       \
</span><span>        ecall
</span><span>
</span><span style="color:#016692;">#define </span><span style="color:#a15001;">TESTNUM</span><span> gp
</span><span style="color:#016692;">#define </span><span style="color:#a15001;">RVTEST_FAIL                                                     </span><span>\
</span><span>        fence;                                                          \
</span><span style="color:#8c008a;">1</span><span style="color:#016692;">:</span><span>      beqz TESTNUM, </span><span style="color:#8c008a;">1</span><span style="background-color:#df68d9bf;color:#a00294;">b</span><span>;                                               \
</span><span>        sll TESTNUM, TESTNUM, </span><span style="color:#8c008a;">1</span><span>;                                        \
</span><span>        or TESTNUM, TESTNUM, </span><span style="color:#8c008a;">1</span><span>;                                         \
</span><span>        li a7, </span><span style="color:#8c008a;">93</span><span>;                                                      \
</span><span>        addi a0, TESTNUM, </span><span style="color:#8c008a;">0</span><span>;                                            \
</span><span>        ecall
</span></code></pre>
<h3 id="disassemble-gajian-tai">disassemble が見たい</h3>
<p>付属ツールで disasm 出力しても良かったが、make 時に一緒に生成されていた。 <code>&lt;elf binary&gt;.dump</code> がそれにあたる。</p>
<p><code>rv32ui-p-addi.dump</code></p>
<pre data-lang="asm" style="background-color:#ffffff;color:#010101;" class="language-asm "><code class="language-asm" data-lang="asm"><span style="color:#a15001;">rv32ui</span><span>-</span><span style="color:#a15001;">p</span><span>-</span><span style="color:#a15001;">addi:     file form</span><span style="color:#7a7025;">at </span><span style="color:#a15001;">elf32</span><span>-</span><span style="color:#a15001;">littleriscv
</span><span>
</span><span>
</span><span style="color:#a15001;">Disassembly of </span><span style="color:#7a7025;">section </span><span style="color:#a15001;">.text.init:
</span><span>
</span><span style="color:#333366;">80000000 </span><span style="color:#a15001;">&lt;_start&gt;:
</span><span style="color:#333366;">80000000</span><span style="color:#a15001;">:	0500006f          	j	</span><span style="color:#333366;">80000050 </span><span style="color:#a15001;">&lt;reset_vector&gt;
</span><span>
</span><span style="color:#333366;">80000004 </span><span style="color:#a15001;">&lt;trap_vector&gt;:
</span><span style="color:#333366;">80000004</span><span style="color:#a15001;">:	34202f73          	csrr	t5</span><span>,</span><span style="color:#a15001;">mcause
</span><span style="color:#333366;">80000008</span><span style="color:#a15001;">:	00800f93          	li	t6</span><span>,</span><span style="color:#333366;">8
</span><span style="color:#a15001;">8000000c:	03ff0863          	beq	t5</span><span>,</span><span style="color:#a15001;">t6</span><span>,</span><span style="color:#a15001;">8000003c &lt;write_tohost&gt;
</span><span>
</span><span style="color:#a15001;">...
</span><span>
</span><span>
</span><span style="color:#a15001;">800003fc &lt;test_25&gt;:
</span><span style="color:#a15001;">800003fc:	</span><span style="color:#333366;">01900193          	</span><span style="color:#a15001;">li	gp</span><span>,</span><span style="color:#333366;">25
</span><span style="color:#333366;">80000400</span><span style="color:#a15001;">:	</span><span style="color:#333366;">02100093          	</span><span style="color:#a15001;">li	ra</span><span>,</span><span style="color:#333366;">33
</span><span style="color:#333366;">80000404</span><span style="color:#a15001;">:	</span><span style="color:#333366;">03208013          	</span><span style="color:#a15001;">addi	zero</span><span>,</span><span style="color:#a15001;">ra</span><span>,</span><span style="color:#333366;">50
</span><span style="color:#333366;">80000408</span><span style="color:#a15001;">:	</span><span style="color:#333366;">00000393          	</span><span style="color:#a15001;">li	t2</span><span>,</span><span style="color:#333366;">0
</span><span style="color:#a15001;">8000040c:	</span><span style="color:#333366;">00701463          	</span><span style="color:#a15001;">bne	zero</span><span>,</span><span style="color:#a15001;">t2</span><span>,</span><span style="color:#333366;">80000414 </span><span style="color:#a15001;">&lt;fail&gt;
</span><span style="color:#333366;">80000410</span><span style="color:#a15001;">:	</span><span style="color:#333366;">02301063          	</span><span style="color:#a15001;">bne	zero</span><span>,</span><span style="color:#a15001;">gp</span><span>,</span><span style="color:#333366;">80000430 </span><span style="color:#a15001;">&lt;pass&gt;
</span><span>
</span><span style="color:#333366;">80000414 </span><span style="color:#a15001;">&lt;fail&gt;:
</span><span style="color:#333366;">80000414</span><span style="color:#a15001;">:	0ff0000f          	fence
</span><span style="color:#333366;">80000418</span><span style="color:#a15001;">:	</span><span style="color:#333366;">00018063          	</span><span style="color:#a15001;">beqz	gp</span><span>,</span><span style="color:#333366;">80000418 </span><span style="color:#a15001;">&lt;fail</span><span>+</span><span style="color:#333366;">0x4</span><span style="color:#a15001;">&gt;
</span><span style="color:#a15001;">8000041c:	</span><span style="color:#333366;">00119193          	</span><span style="color:#a15001;">slli	gp</span><span>,</span><span style="color:#a15001;">gp</span><span>,</span><span style="color:#333366;">0x1
</span><span style="color:#333366;">80000420</span><span style="color:#a15001;">:	0011e193          	ori	gp</span><span>,</span><span style="color:#a15001;">gp</span><span>,</span><span style="color:#333366;">1
</span><span style="color:#333366;">80000424</span><span style="color:#a15001;">:	05d00893          	li	a7</span><span>,</span><span style="color:#333366;">93
</span><span style="color:#333366;">80000428</span><span style="color:#a15001;">:	</span><span style="color:#333366;">00018513          	</span><span style="color:#a15001;">mv	a0</span><span>,</span><span style="color:#a15001;">gp
</span><span style="color:#a15001;">8000042c:	</span><span style="color:#333366;">00000073          	</span><span style="color:#a15001;">ecall
</span><span>
</span><span style="color:#333366;">80000430 </span><span style="color:#a15001;">&lt;pass&gt;:
</span><span style="color:#333366;">80000430</span><span style="color:#a15001;">:	0ff0000f          	fence
</span><span style="color:#333366;">80000434</span><span style="color:#a15001;">:	</span><span style="color:#333366;">00100193          	</span><span style="color:#a15001;">li	gp</span><span>,</span><span style="color:#333366;">1
</span><span style="color:#333366;">80000438</span><span style="color:#a15001;">:	05d00893          	li	a7</span><span>,</span><span style="color:#333366;">93
</span><span style="color:#a15001;">8000043c:	</span><span style="color:#333366;">00000513          	</span><span style="color:#a15001;">li	a0</span><span>,</span><span style="color:#333366;">0
</span><span style="color:#333366;">80000440</span><span style="color:#a15001;">:	</span><span style="color:#333366;">00000073          	</span><span style="color:#a15001;">ecall
</span><span style="color:#333366;">80000444</span><span style="color:#a15001;">:	c0001073          	unimp
</span><span style="color:#333366;">80000448</span><span style="color:#a15001;">:	</span><span style="color:#333366;">0000                	</span><span style="color:#a15001;">.insn	</span><span style="color:#333366;">2</span><span>, </span><span style="color:#a15001;">0x
</span><span style="color:#a15001;">8000044a:	</span><span style="color:#333366;">0000                	</span><span style="color:#a15001;">.insn	</span><span style="color:#333366;">2</span><span>, </span><span style="color:#a15001;">0x
</span><span style="color:#a15001;">8000044c:	</span><span style="color:#333366;">0000                	</span><span style="color:#a15001;">.insn	</span><span style="color:#333366;">2</span><span>, </span><span style="color:#a15001;">0x
</span><span style="color:#a15001;">8000044e:	</span><span style="color:#333366;">0000                	</span><span style="color:#a15001;">.insn	</span><span style="color:#333366;">2</span><span>, </span><span style="color:#a15001;">0x
</span><span style="color:#333366;">80000450</span><span style="color:#a15001;">:	</span><span style="color:#333366;">0000                	</span><span style="color:#a15001;">.insn	</span><span style="color:#333366;">2</span><span>, </span><span style="color:#a15001;">0x
</span><span style="color:#333366;">80000452</span><span style="color:#a15001;">:	</span><span style="color:#333366;">0000                	</span><span style="color:#a15001;">.insn	</span><span style="color:#333366;">2</span><span>, </span><span style="color:#a15001;">0x
</span><span style="color:#333366;">80000454</span><span style="color:#a15001;">:	</span><span style="color:#333366;">0000                	</span><span style="color:#a15001;">.insn	</span><span style="color:#333366;">2</span><span>, </span><span style="color:#a15001;">0x
</span><span style="color:#333366;">80000456</span><span style="color:#a15001;">:	</span><span style="color:#333366;">0000                	</span><span style="color:#a15001;">.insn	</span><span style="color:#333366;">2</span><span>, </span><span style="color:#a15001;">0x
</span><span style="color:#333366;">80000458</span><span style="color:#a15001;">:	</span><span style="color:#333366;">0000                	</span><span style="color:#a15001;">.insn	</span><span style="color:#333366;">2</span><span>, </span><span style="color:#a15001;">0x
</span><span style="color:#a15001;">8000045a:	</span><span style="color:#333366;">0000                	</span><span style="color:#a15001;">.insn	</span><span style="color:#333366;">2</span><span>, </span><span style="color:#a15001;">0x
</span><span style="color:#a15001;">8000045c:	</span><span style="color:#333366;">0000                	</span><span style="color:#a15001;">.insn	</span><span style="color:#333366;">2</span><span>, </span><span style="color:#a15001;">0x
</span><span style="color:#a15001;">8000045e:	</span><span style="color:#333366;">0000                	</span><span style="color:#a15001;">.insn	</span><span style="color:#333366;">2</span><span>, </span><span style="color:#a15001;">0x
</span><span style="color:#333366;">80000460</span><span style="color:#a15001;">:	</span><span style="color:#333366;">0000                	</span><span style="color:#a15001;">.insn	</span><span style="color:#333366;">2</span><span>, </span><span style="color:#a15001;">0x
</span><span style="color:#333366;">80000462</span><span style="color:#a15001;">:	</span><span style="color:#333366;">0000                	</span><span style="color:#a15001;">.insn	</span><span style="color:#333366;">2</span><span>, </span><span style="color:#a15001;">0x
</span><span style="color:#333366;">80000464</span><span style="color:#a15001;">:	</span><span style="color:#333366;">0000                	</span><span style="color:#a15001;">.insn	</span><span style="color:#333366;">2</span><span>, </span><span style="color:#a15001;">0x
</span><span style="color:#333366;">80000466</span><span style="color:#a15001;">:	</span><span style="color:#333366;">0000                	</span><span style="color:#a15001;">.insn	</span><span style="color:#333366;">2</span><span>, </span><span style="color:#a15001;">0x
</span><span style="color:#333366;">80000468</span><span style="color:#a15001;">:	</span><span style="color:#333366;">0000                	</span><span style="color:#a15001;">.insn	</span><span style="color:#333366;">2</span><span>, </span><span style="color:#a15001;">0x
</span><span style="color:#a15001;">8000046a:	</span><span style="color:#333366;">0000                	</span><span style="color:#a15001;">.insn	</span><span style="color:#333366;">2</span><span>, </span><span style="color:#a15001;">0x
</span><span style="color:#a15001;">8000046c:	</span><span style="color:#333366;">0000                	</span><span style="color:#a15001;">.insn	</span><span style="color:#333366;">2</span><span>, </span><span style="color:#a15001;">0x
</span><span style="color:#a15001;">8000046e:	</span><span style="color:#333366;">0000                	</span><span style="color:#a15001;">.insn	</span><span style="color:#333366;">2</span><span>, </span><span style="color:#a15001;">0x
</span><span style="color:#333366;">80000470</span><span style="color:#a15001;">:	</span><span style="color:#333366;">0000                	</span><span style="color:#a15001;">.insn	</span><span style="color:#333366;">2</span><span>, </span><span style="color:#a15001;">0x
</span><span style="color:#333366;">80000472</span><span style="color:#a15001;">:	</span><span style="color:#333366;">0000                	</span><span style="color:#a15001;">.insn	</span><span style="color:#333366;">2</span><span>, </span><span style="color:#a15001;">0x
</span><span style="color:#333366;">80000474</span><span style="color:#a15001;">:	</span><span style="color:#333366;">0000                	</span><span style="color:#a15001;">.insn	</span><span style="color:#333366;">2</span><span>, </span><span style="color:#a15001;">0x
</span><span style="color:#333366;">80000476</span><span style="color:#a15001;">:	</span><span style="color:#333366;">0000                	</span><span style="color:#a15001;">.insn	</span><span style="color:#333366;">2</span><span>, </span><span style="color:#a15001;">0x
</span><span style="color:#333366;">80000478</span><span style="color:#a15001;">:	</span><span style="color:#333366;">0000                	</span><span style="color:#a15001;">.insn	</span><span style="color:#333366;">2</span><span>, </span><span style="color:#a15001;">0x
</span><span style="color:#a15001;">8000047a:	</span><span style="color:#333366;">0000                	</span><span style="color:#a15001;">.insn	</span><span style="color:#333366;">2</span><span>, </span><span style="color:#a15001;">0x
</span></code></pre>

        </div>

                </div>
            
                <div class="post on-list">
                    
    <h1 class="post-title"><a href="https://blog.wipeseals.me/blog/2025/setup-litex/">LiteX を Ubuntu 24.04 on WSL2 で使用し、 Demo Applicationを動作させる</a></h1>
    <div class="post-meta-inline">
        
    <span class="post-date">
            2025-02-24
        </span>

    </div>

    
        <span class="post-tags-inline">
                :: tags:&nbsp;
                <a class="post-tag" href="https://blog.wipeseals.me/tags/embedded/">#Embedded</a>&nbsp;
                <a class="post-tag" href="https://blog.wipeseals.me/tags/linux/">#Linux</a>&nbsp;
                <a class="post-tag" href="https://blog.wipeseals.me/tags/fpga/">#fpga</a>&nbsp;
                <a class="post-tag" href="https://blog.wipeseals.me/tags/litex/">#litex</a>&nbsp;
                <a class="post-tag" href="https://blog.wipeseals.me/tags/riscv/">#riscv</a>&nbsp;
                <a class="post-tag" href="https://blog.wipeseals.me/tags/tech/">#tech</a></span>
    


                    
        <div class="post-content">
            <p>LiteX を Windows 環境で使用したく、試していたときの備忘録。以下の通り無事 demo app の動作確認までたどり着けたので書き残す。</p>
<p><img src="/2025/setup-litex/vexriscv-donut.mp4.gif" alt="movie gif" /></p>
<hr />
<h2 id="shou-shun-matome">手順まとめ</h2>
<p>時系列順に実行した内容のまとめを先に記載する。細かいトラブルシューティングは後半に記載。</p>
<h3 id="huan-jing-gou-zhu">環境構築</h3>
<p>基本手順は<a href="https://github.com/enjoy-digital/litex?tab=readme-ov-file#quick-start-guide">公式ドキュメントの Quick Start Guide</a>に従い、WSL2 上にインストールした Ubuntu 24.04 で行う。
要点は以下。</p>
<ul>
<li>virtualenv を作成し、Python 仮想環境中で実行する</li>
<li>virtualenv 中で user install を実行するとエラーになるため、 <code>--user</code> オプションを使用しない</li>
<li>litex の repo ごと取得した状態で <code>litex_setup.py</code> を実行しない</li>
</ul>
<pre data-lang="sh" style="background-color:#ffffff;color:#010101;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#898989;"># verilator導入
</span><span style="color:#696989;">$</span><span> sudo apt install verilator
</span><span>
</span><span style="color:#898989;"># litexの取得
</span><span style="color:#696989;">$</span><span> wget https://raw.githubusercontent.com/enjoy-digital/litex/master/litex_setup.py
</span><span style="color:#696989;">$</span><span> chmod +x litex_setup.py
</span><span>
</span><span style="color:#898989;"># venv導入
</span><span style="color:#696989;">$</span><span> sudo apt install python3-venv
</span><span style="color:#898989;"># 仮想環境作成 + activate
</span><span style="color:#696989;">$</span><span> python3</span><span style="color:#696989;"> -m</span><span> venv .venv
</span><span style="color:#696989;">$</span><span> source .venv/bin/activate
</span><span>
</span><span style="color:#898989;"># litex_setup.py の実行
</span><span style="color:#696989;">$</span><span> python3 ./litex_setup.py</span><span style="color:#696989;"> --init --install --config</span><span style="color:#016692;">=</span><span>full
</span><span>
</span><span style="color:#898989;"># RSC-V toolchain の導入 (binutils-riscv* 等が導入されるので管理者権限必要)
</span><span style="color:#696989;">$</span><span> pip3 install meson ninja
</span><span style="color:#696989;">$</span><span> sudo ./litex_setup.py</span><span style="color:#696989;"> --gcc</span><span style="color:#016692;">=</span><span>riscv
</span></code></pre>
<h3 id="shi-ji-wu-sidenotesuto">実機無しでのテスト</h3>
<p>ハマりポイントは特になし。verilator があれば動くはず。</p>

        </div>
        <div>
            <!-- &#xFE0E; -- force text style - some devices render this as emoji -->
            <a class="read-more button" href="https://blog.wipeseals.me/blog/2025/setup-litex/">
                <span class="button__text">Read more</span>&nbsp;
                <span class="button__icon">&#8617;&#xFE0E;</span>
            </a>
        </div>
    

                </div>
            
                <div class="post on-list">
                    
    <h1 class="post-title"><a href="https://blog.wipeseals.me/blog/2024/create-vrchat-game/">VRChatで動くボードゲームを作る</a></h1>
    <div class="post-meta-inline">
        
    <span class="post-date">
            2024-11-14
        </span>

    </div>

    
        <span class="post-tags-inline">
                :: tags:&nbsp;
                <a class="post-tag" href="https://blog.wipeseals.me/tags/c/">#C#</a>&nbsp;
                <a class="post-tag" href="https://blog.wipeseals.me/tags/game/">#Game</a>&nbsp;
                <a class="post-tag" href="https://blog.wipeseals.me/tags/udon/">#Udon</a>&nbsp;
                <a class="post-tag" href="https://blog.wipeseals.me/tags/udonsharp/">#UdonSharp</a>&nbsp;
                <a class="post-tag" href="https://blog.wipeseals.me/tags/unity/">#Unity</a>&nbsp;
                <a class="post-tag" href="https://blog.wipeseals.me/tags/vrchat/">#VRChat</a>&nbsp;
                <a class="post-tag" href="https://blog.wipeseals.me/tags/tech/">#tech</a></span>
    


                    
        <div class="post-content">
            <p>掲題の通り、VRChat 上で動作するボードゲームを先日公開した。自分自身の備忘録また同様の制作を行いたく情報を探している人向けの制作記録として機能することを願って作業記録を残すことにする。</p>
<ul>
<li><a href="https://wipeseals.booth.pm/items/6278798">[無料] UdonKnucklebones [UdonChips 対応] - Booth</a></li>
<li><a href="https://github.com/wipeseals/UdonKnucklebones">wipeseals/UdonKnucklebones - GitHub</a></li>
</ul>
<p><img src="/2024/create-vrchat-game/2024-11-10-170028.png" alt="ss" /></p>
<hr />
<h2 id="zuo-rumono">作るもの</h2>
<p>Knucklebones（ナックルボーン）と呼ばれるボードゲームを作ることにした。本家は<a href="https://store.steampowered.com/app/1313140/Cult_of_the_Lamb/?l=japanese">Cult of the Lamb</a> 作中に登場するゲームであり、今回の制作は非公式ファンアートの位置づけである。</p>
<p>サイコロを振って並べるという単純明快なルールでありながら、駆け引き要素がよくできたゲームである。（高得点を狙うほど、相手から一網打尽にされるリスクが上がっていく）
もちろん、Knucklebones だけでなくゲーム自体の完成度もすばらしいのでぜひ遊んでみてほしい。</p>
<h2 id="zhi-zuo-shou-shun">制作手順</h2>
<p>おおよそ以下の手順で進めた。あくまでいち参考として見ていただけるとありがたい。</p>
<ol>
<li>ゲームシステム試作</li>
<li>モデリング</li>
<li>VCC 配布可能な Unity Project 作成</li>
<li>モデルの Unity Setup</li>
<li>ゲームロジック 実装</li>
<li>動作確認</li>
<li>サンプルワールド作成</li>
<li>配布準備</li>
</ol>

        </div>
        <div>
            <!-- &#xFE0E; -- force text style - some devices render this as emoji -->
            <a class="read-more button" href="https://blog.wipeseals.me/blog/2024/create-vrchat-game/">
                <span class="button__text">Read more</span>&nbsp;
                <span class="button__icon">&#8617;&#xFE0E;</span>
            </a>
        </div>
    

                </div>
            <div class="pagination">
                <div class="pagination__buttons">
                    <span class="button next">
                        <a href="https://blog.wipeseals.me/page/2/">
                            <span class="button__text">Older posts</span>&nbsp;
                            <span class="button__icon">→</span>
                        </a>
                    </span>
                </div>
            </div>
        </div>
        
    </div>

    
    <footer class="footer">
        <div class="footer__inner">
                <div class="copyright copyright--user">Copyright &copy; 2025 wipeseals</div>
            </div>
    </footer>
    

</div>
</body>

</html>
